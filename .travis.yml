language: rust

env:
  global:
    - secure: B/kcbcUvqUkSXNcbfjA8AQgC57IgWIGd8jgjysAuJUbv02e0PjyGK864NCIMn+UeUwhdni8F73EtEkJS6fiJ69BO7sVQzgN47ePG5nPnzgXieOcyLABtUsozZfB2Jy7HPbXCBN313wohmGvDwRPf0w4vszfmryfgCXe9haXGGFc=
  matrix:
    - BLAS=OpenBLAS
    - BLAS=reference

before_install:
  # This PPA has a newer version of OpenBLAS
  - if [[ $BLAS == 'OpenBLAS' ]]; then
      sudo add-apt-repository ppa:staticfloat/julia-deps -y;
    fi
  - sudo apt-get update

install:
  - if [[ $BLAS == 'OpenBLAS' ]]; then
      sudo apt-get install libopenblas-dev;
    else
      sudo apt-get install libblas-dev;
    fi
  - git clone --depth 1 https://github.com/japaric/cfail.rs

script:
  - if [[ $BLAS == 'OpenBLAS' ]]; then
      export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib/openblas-base;
    fi
  - cargo build --features macros --verbose
  - if [[ $BLAS == 'OpenBLAS' ]]; then
      RUST_TEST_THREADS=1 cargo test --features macros --verbose;
    else
      cargo test --features macros --verbose;
    fi
  - cargo doc --features macros --verbose
  - cd cfail.rs && cargo build --release && cd ..
  - CFAIL_LIBRARY_PATH=target/debug:target/debug/deps cfail.rs/target/release/cfail tests/cfail/*.rs
  - rm -rf cfail.rs
  - ./check-line-length.sh

after_success:
  - '[ "${TRAVIS_PULL_REQUEST}" = "false" ] && bash upload-docs.sh'

branches:
  only: master

notifications:
  email:
    on_success: never
